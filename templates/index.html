<!DOCTYPE html>
<html>
<head>
    <title>暴躁的教授读论文</title>
    <!-- 新增Ant Design -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/antd@4.24.8/dist/antd.min.css">
    <script src="https://cdn.jsdelivr.net/npm/antd@4.24.8/dist/antd.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
    <link rel="stylesheet" href="/static/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/contrib/auto-render.min.js"></script>

</head>

<body>
    <div class="container">
        <!-- 左侧菜单栏 -->
        <div class="left-sidebar">
            <h2>📚 论文列表</h2>
            <button class="ant-btn ant-btn-circle toggle-btn" onclick="toggleSidebar('left')">◀</button>
            
            <div class="ant-select ant-select-single">
                <div class="ant-select-selector">
                    <select id="paper-select" class="ant-select-selection-search-input">
                        {% for paper in papers %}
                        <option value="{{ paper.id }}">{{ paper.title }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        
            <form class="ant-upload ant-upload-drag" enctype="multipart/form-data">
                <input 
                  type="file" 
                  class="ant-upload-input" 
                  accept=".pdf,.jpg" 
                  multiple
                  onchange="handleFileSelect(event)"
                >
                <div class="ant-upload-text">
                  <span class="ant-upload-drag-icon">📤</span>
                  <p>拖拽或点击上传文件</p>
                </div>
            </form>
        </div>

        <!-- 中间内容区 -->
        <div class="main-content">
            <h2>📄 论文内容</h2>
            <div id="paper-content">
                {% if selected_paper %}
                <div id="paper-renderer" class="prose">
                    <!-- 删除paper变量引用 -->
                </div>
                {% endif %}
            </div>
        </div>

        <!-- 右侧聊天栏 -->
        <div class="right-sidebar">
            <div class="lang-switch">
                <button onclick="switchLanguage('zh')">中文</button>
                <button onclick="switchLanguage('en')">English</button>
            </div>
            <h2>💬 AI对话</h2>
            <div class="ant-comment-inner" id="chat-messages"></div>
            
            <div class="ant-input-group">
                <input type="text" 
                       id="user-input" 
                       class="ant-input"
                       placeholder="输入问题..."
                       style="width: calc(100% - 80px)">
                <button 
                    class="ant-btn ant-btn-primary" 
                    onclick="submitQuestion()"
                    style="width: 70px; margin-left: 10px">
                    发送
                </button>
            </div>
            <button class="ant-btn ant-btn-circle toggle-btn" onclick="toggleSidebar('right')">▶</button>
        </div>

        </div>
    </div>
</body>
</html>

<script>
// 修改初始化逻辑
document.addEventListener('DOMContentLoaded', function() {
    const initialPaperId = "{{ selected_paper }}";
    if(initialPaperId) {
        // 通过API获取论文内容
        fetch(`/paper/${initialPaperId}`)
            .then(response => response.json())
            .then(data => {
                document.getElementById('paper-renderer').innerHTML = data.zh_content;
                renderKatex();
            });
    }
});


// 初始化函数
function initPaperContent(paperId) {
    fetch(`/paper/${paperId}`)
        .then(response => response.json())
        .then(data => {
            const content = document.getElementById('paper-content');
            content.innerHTML = data.zh_content; // 根据语言切换
            renderKatex(); // 调用KaTeX渲染
        });
}

// 提交问题函数
function submitQuestion() {
    const input = document.getElementById('user-input').value;
    fetch('/chat', {
        method: 'POST',
        body: JSON.stringify({
            prompt: input,
            paper_id: currentPaperId // 需要维护当前论文ID
        }),
        headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => {
        appendChatMessage(data.response);
    });
}

// KaTeX渲染函数（JS实现）
function renderKatex() {
    renderMathInElement(document.body, {
        delimiters: [
            {left: '$$', right: '$$', display: true},
            {left: '$', right: '$', display: false}
        ],
        throwOnError: false
    });
    // document.querySelectorAll('.arithmatex:not(.rendered)').forEach(el => {
    //     katex.render(el.textContent, el, { throwOnError: false });
    //     el.classList.add('rendered'); // 标记已渲染
    // });
}

function toggleSidebar(side) {
    const left = document.querySelector('.left-sidebar');
    const right = document.querySelector('.right-sidebar');
    
    if(side === 'left') {
        left.style.flex = left.style.flex === '0' ? '1' : '0';
        document.querySelector('.left-sidebar .toggle-btn').innerHTML = 
            left.style.flex === '0' ? '▶' : '◀';
    } else {
        right.style.flex = right.style.flex === '0' ? '1' : '0';
        document.querySelector('.right-sidebar .toggle-btn').innerHTML = 
            right.style.flex === '0' ? '◀' : '▶';
    }
}

function handleFileSelect(e) {
const files = e.target.files;
    // 手动实现文件校验（模拟beforeUpload）
    if (files[0].size > 1024 * 1024 * 100) {
        alert('文件大小超过100MB限制');
        return;
    }
    // 手动提交到FastAPI接口
    const formData = new FormData();
    formData.append('file', files[0]);
    fetch('/upload', { method: 'POST', body: formData })
    .then(response => response.json())
    .then(data => console.log('上传成功', data));
}

// 初始化时加载默认选中的论文
document.addEventListener('DOMContentLoaded', function() {
    const initialPaperId = "{{ selected_paper }}";
    if(initialPaperId) {
        loadPaperContent(initialPaperId);
    }
});

// 论文选择事件处理
document.getElementById('paper-select').addEventListener('change', function(e) {
    loadPaperContent(e.target.value);
});

async function loadPaperContent(paperId) {
    try {
        const response = await fetch(`/paper/${paperId}`);
        const data = await response.json();
        
        const contentDiv = document.getElementById('paper-renderer');
        const lang = document.querySelector('input[name="lang-toggle"]:checked').value;
        contentDiv.innerHTML = lang === 'zh' ? data.zh_content : data.en_content;
        
        // 重新渲染数学公式
        renderKatex();
    } catch (error) {
        console.error('论文加载失败:', error);
    }
}
</script>
